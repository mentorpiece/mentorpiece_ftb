<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<!-- layout:decorate="~{layout/master-page}">-->
<head>
    <title>Log in</title>
    <meta charset="UTF-8">
    <div>
        <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css"
              integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT"
              rel="stylesheet">
        <style>
            .dropdown-menu {
                position: absolute;
                top: 100%;
                left: 0;
                z-index: 1000;
                display: none;
                min-width: 160px;
                padding: 0.5rem 0;
                margin: 0;
                font-size: 0.875rem;
                color: #212529;
                text-align: left;
                list-style: none;
                background-color: #fff;
                background-clip: padding-box;
                border: 1px solid rgba(0,0,0,.15);
                border-radius: 0.375rem;
            }
            .dropdown-menu.show {
                display: block;
            }
            .dropdown-item:hover {
                background-color: #e9ecef;
            }
        </style>
    </div>
    <style type="text/css"></style>
</head>
<body>
<div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary" style="margin-bottom: 20px">
        <a class="navbar-brand" href="robots.txt.html#">
            <img height="25" src="http://localhost:8080/img/aero-ico.png">
            FTB
        </a>

        <button aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"
                data-target="#navbarColor02" data-toggle="collapse" type="button">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarColor02">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a id = "aHome" class="nav-link" href="http://localhost:8080/">Home</a>
                </li>
                <!-- Show all options for users since they can switch roles -->
                

            </ul>

            <div class="navbar-nav ms-auto">
                
                <div style="margin-right: 15px;">
                    <a id = "aLogin" class="btn btn-success btn-sm" href="robots.txt.html">Login</a>
                </div>
            </div>
        </div>
    </nav>
    <div class="container">
        
    </div>

    <script crossorigin="anonymous"
            integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>
    <script crossorigin="anonymous"
            integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
            src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script crossorigin="anonymous"
            integrity="sha384-7VPbUDkoPSGFnVtYi0QogXtr74QeVeeIs99Qfg5YCF+TidwNdjvaKZX19NZ/e6oz"
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js"></script>

    <script>
        // Manual dropdown toggle function as fallback
        function toggleDropdown() {
            console.log('Toggle dropdown clicked');
            const dropdown = document.getElementById('roleDropdownMenu');
            const button = document.getElementById('roleDropdown');

            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                button.setAttribute('aria-expanded', 'false');
            } else {
                dropdown.classList.add('show');
                button.setAttribute('aria-expanded', 'true');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('roleDropdownMenu');
            const button = document.getElementById('roleDropdown');

            if (dropdown && button && !button.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
                button.setAttribute('aria-expanded', 'false');
            }
        });

        function switchRole(roleName) {
            console.log('Switching to role:', roleName);

            // Close the dropdown
            const dropdown = document.getElementById('roleDropdownMenu');
            const button = document.getElementById('roleDropdown');
            if (dropdown && button) {
                dropdown.classList.remove('show');
                button.setAttribute('aria-expanded', 'false');
            }

            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/switch-role';

            const roleInput = document.createElement('input');
            roleInput.type = 'hidden';
            roleInput.name = 'role';
            roleInput.value = roleName;

            // Add CSRF token if available (Spring Security disabled CSRF, but good practice)
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
            if (csrfToken && csrfHeader) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_csrf';
                csrfInput.value = csrfToken.getAttribute('content');
                form.appendChild(csrfInput);
            }

            form.appendChild(roleInput);
            document.body.appendChild(form);

            // Immediately update the dropdown text to show switching state
            const currentRoleDisplay = document.getElementById('currentRoleDisplay');
            if (currentRoleDisplay) {
                if (roleName === 'ROLE_USER') {
                    currentRoleDisplay.textContent = '👤 User';
                } else if (roleName === 'ROLE_AGENT') {
                    currentRoleDisplay.textContent = '🎫 Agent';
                } else if (roleName === 'ROLE_ADMIN') {
                    currentRoleDisplay.textContent = '⚙️ Admin';
                }
            }

            form.submit();
        }

        // Function to update menu visibility and role display based on current role
        function updateMenuVisibility() {
            fetch('/api/current-user')
                .then(response => response.json())
                .then(userInfo => {
                    console.log('Current user info:', userInfo); // Debug log
                    let roleDisplayText = 'Role';

                    if (userInfo.currentRole === 'ROLE_USER') {
                        roleDisplayText = '👤 User';
                        document.getElementById('bookingMenuItem').style.display = 'none';
                        document.getElementById('aircraftMenuItem').style.display = 'none';
                        document.getElementById('airportMenuItem').style.display = 'none';
                    } else if (userInfo.currentRole === 'ROLE_AGENT') {
                        roleDisplayText = '🎫 Agent';
                        document.getElementById('bookingMenuItem').style.display = 'block';
                        document.getElementById('aircraftMenuItem').style.display = 'block';
                        document.getElementById('airportMenuItem').style.display = 'block';
                    } else if (userInfo.currentRole === 'ROLE_ADMIN') {
                        roleDisplayText = '⚙️ Admin';
                        document.getElementById('bookingMenuItem').style.display = 'none';
                        document.getElementById('aircraftMenuItem').style.display = 'block';
                        document.getElementById('airportMenuItem').style.display = 'block';
                    } else {
                        document.getElementById('bookingMenuItem').style.display = 'none';
                        document.getElementById('aircraftMenuItem').style.display = 'none';
                        document.getElementById('airportMenuItem').style.display = 'none';
                    }

                    console.log('Setting role display to:', roleDisplayText); // Debug log

                    // Update the dropdown button text to show current role
                    const currentRoleDisplay = document.getElementById('currentRoleDisplay');
                    if (currentRoleDisplay) {
                        currentRoleDisplay.textContent = roleDisplayText;
                        // Force a re-render by setting innerHTML as well
                        currentRoleDisplay.innerHTML = roleDisplayText;
                        console.log('Updated dropdown display to:', currentRoleDisplay.textContent); // Debug log
                    } else {
                        console.error('currentRoleDisplay element not found!');
                    }
                })
                .catch(error => {
                    console.error('Error fetching current user:', error);
                    // Default to hide restricted menu items on error
                    document.getElementById('bookingMenuItem').style.display = 'none';
                    document.getElementById('aircraftMenuItem').style.display = 'none';
                    document.getElementById('airportMenuItem').style.display = 'none';
                    // Reset role display
                    const currentRoleDisplay = document.getElementById('currentRoleDisplay');
                    if (currentRoleDisplay) {
                        currentRoleDisplay.textContent = 'Role';
                    }
                });
        }

        // Function to check URL parameters and update role if needed
        function checkUrlForRoleChange() {
            const urlParams = new URLSearchParams(window.location.search);
            const roleChanged = urlParams.get('roleChanged');
            if (roleChanged) {
                console.log('Role change detected in URL:', roleChanged);
                // Force immediate update
                setTimeout(() => {
                    updateMenuVisibility();
                }, 50);
                setTimeout(() => {
                    updateMenuVisibility();
                }, 200);
                setTimeout(() => {
                    updateMenuVisibility();
                }, 500);
            }
        }

        // Update menu visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateMenuVisibility();
            checkUrlForRoleChange();
        });

        // Also update on window load to catch any delayed redirects
        window.addEventListener('load', function() {
            updateMenuVisibility();
            checkUrlForRoleChange();
        });

        // Periodic check to ensure role display is correct (runs for first 5 seconds)
        let checkCount = 0;
        const periodicCheck = setInterval(() => {
            checkCount++;
            updateMenuVisibility();
            if (checkCount >= 10) { // Stop after 10 checks (5 seconds)
                clearInterval(periodicCheck);
            }
        }, 500);
    </script>
</div>
<div class="container">
    
        <div class="row justify-content-md-center">
            <div class="col-md-4 jumbotron" style="padding: 20px; margin: 0 15px;">
                <h2 style="text-align: center">Login Form</h2>

                <form method="post" name="formLogin" action="robots.txt.html">
                    
                    
                    
                    <div class="form-group">
                        <label for="txtUsername">Username</label>
                        <!-- <span th:if="${#fields.hasErrors('username')}" th:errors="*{username}"
                              class="alert alert-danger"></span> -->
                        <input autofocus="autofocus" class="form-control" id="txtUsername" name="username" type="text"/>
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="txtPassword">Password</label>
                        <!-- <span th:if="${#fields.hasErrors('password')}" th:errors="*{password}"
                              class="alert alert-danger"></span> -->
                        <input class="form-control" id="txtPassword" name="password" type="password"/>
                    </div>
                    <div style="text-align: right; margin-right: 20px; margin-top: 15px;">
                        <a class="btn btn-outline-warning" href="http://localhost:8080/">Cancel</a>&nbsp;&nbsp;&nbsp;
                        <button class="btn btn-outline-success" id="btnSubmit" type="submit">Sign In</button>
                    </div>
                </form>

                <div style="text-align: center; margin-top: 25px; padding: 0 20px;">
                    <p style="margin-bottom: 0;">Don't have an account? <a href="http://localhost:8080/register">Register here</a></p>
                </div>
            </div>
        </div>
    
</div>
</body>
</html>